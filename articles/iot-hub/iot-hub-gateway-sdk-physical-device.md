<properties
	pageTitle="Use a real device with the IoT Gateway SDK | Microsoft Azure"
	description="Azure IoT Gateway SDK walkthrough using a Texas Instruments SensorTag device to send data to IoT Hub through a gateway running on A Raspberry Pi 3"
	services="iot-hub"
	documentationCenter=""
	authors="chipalost"
	manager="timlt"
	editor=""/>

<tags
     ms.service="iot-hub"
     ms.devlang="cpp"
     ms.topic="article"
     ms.tgt_pltfrm="na"
     ms.workload="na"
     ms.date="11/01/2016"
     ms.author="andbuc"/>


# Azure IoT Gateway SDK (beta) â€“ send device-to-cloud messages with a real device using Linux

This walkthrough of the [Bluetooth low energy sample][lnk-ble-samplecode] shows you how to use the [Azure IoT Gateway SDK][lnk-sdk] to forward device-to-cloud telemetry to IoT Hub from a physical device and how to route commands from IoT Hub to a physical device.

This walkthrough covers:

* **Architecture**: important architectural information about the Bluetooth low energy sample.

* **Build and run**: the steps required to build and run the sample.

## Architecture

The walkthrough shows you how to build and run an IoT Gateway on a Raspberry Pi 3 that runs Raspbian Linux. The gateway is built using the IoT Gateway SDK. The sample uses a Texas Instruments SensorTag Bluetooth Low Energy (BLE) device to collect temperature data.

When you run the gateway it:

- Connects to a SensorTag device using the Bluetooth Low Energy (BLE) protocol.
- Connects to IoT Hub using the HTTP protocol.
- Forwards telemetry from the SensorTag device to IoT Hub.
- Routes commands from IoT Hub to the SensorTag device.

The gateway contains the following modules:

- A *BLE module* that interfaces with a BLE device to receive temperature data from the device and send commands to the device.
- A *BLE Cloud to Device module* that translates the JSON messages coming from the cloud into BLE instructions for the *BLE module*.
- A *logger module* that logs all gateway messages.
- An *identity mapping module* that translates between BLE device MAC addresses and Azure IoT Hub device identities.
- An *IoT Hub module* that uploads telemetry data to an IoT hub and receives device commands from an IoT hub.
- A *BLE printer module* that interprets telemetry from the BLE device and prints formatted data to the console to enable troubleshooting and debugging.

### How data flows through the Gateway

The following block diagram illustrates the telemetry upload data flow pipeline:

![](media/iot-hub-gateway-sdk-physical-device/gateway_ble_upload_data_flow.png)

The steps that an item of telemetry takes traveling from a BLE device to IoT Hub are:

1. The BLE device generates a temperature sample and sends it over Bluetooth to the BLE module in the gateway.
2. The BLE module receives the sample and publishes it to the broker along with the MAC address of the device.
3. The identity mapping module picks up this message and uses an internal table to translate the MAC address of the device into an IoT Hub device identity (a device ID and device key). It then publishes a new message that contains the temperature sample data, the MAC address of the device, the device ID, and the device key.
4. The IoT Hub module receives this new message (generated by the identity mapping module) and publishes it to IoT Hub.
5. The logger module logs all messages from the broker to a disk file.

The following block diagram illustrates the device command data flow pipeline:

![](media/iot-hub-gateway-sdk-physical-device/gateway_ble_command_data_flow.png)

1. The IoT Hub module periodically polls the IoT hub for new command messages.
2. When the IoT Hub module receives a new command message, it publishes it to the broker.
3. The identity mapping module picks up the command message and uses an internal table to translate the IoT Hub device ID to a device MAC address. It then publishes a new message that includes the MAC address of the target device in the properties map of the message.
4. The BLE Cloud to Device module picks up this message and translates it into the proper BLE instruction for the BLE module. It then publishes a new message.
5. The BLE module picks up this message and executes the I/O instruction by communicating with the BLE device.
6. The logger module logs all messages from the broker to a disk file.

## Prepare your hardware

This tutorial assumes you are using a [Texas Instruments SensorTag](http://www.ti.com/ww/en/wireless_connectivity/sensortag2015/index.html) device connected to a Raspberry Pi 3 running Raspbian.

### Install Raspbian

You can use either of the following options to install Raspbian on your Raspberry Pi 3 device. 

- Use [NOOBS][lnk-noobs], a graphical user interface, to install the latest version of Raspbian. 
- Manually [download][lnk-raspbian] and write the latest image of the Raspbian operating system to a SD card. 

### Install BlueZ 5.37
The BLE modules talk to the Bluetooth hardware via the BlueZ stack. You need version 5.37 of BlueZ for the modules to work correctly. These instructions make sure the correct version of BlueZ is installed.

1. Stop the current bluetooth daemon:
    
    ```
    sudo systemctl stop bluetooth
    ```

2. Install dbus, a BlueZ dependency. 
    
    ```
    sudo apt-get install libdbus-1-dev
    ```
 
3. Install ical, a BlueZ dependency. 
    
    ```
    sudo apt-get install libical-dev
    ```

4. Install readline, a BlueZ dependency. 
    
    ```
    sudo apt-get install libreadline-dev
    ```

5. Download the BlueZ source code from bluez.org. 
    
    ```
    wget http://www.kernel.org/pub/linux/bluetooth/bluez-5.37.tar.xz
    ```

6. Unzip the source code.
    
    ```
    tar -xvf bluez-5.37.tar.xz
    ```

7. Change directories to the newly created folder.
    
    ```
    cd bluez-5.37
    ```

8. Build BlueZ.
    
    ```
    make
    ```

9. Install BlueZ once it is done building.
    
    ```
    sudo make install
    ```

10. Change systemd service configuration for bluetooth so it points to the new bluetooth daemon in the file `/lib/systemd/system/bluetooth.service`. Replace the 'ExecStart' line with the following text: 
    
    ```
    ExecStart=/usr/local/libexec/bluetooth/bluetoothd -E
    ```

### Enable connectivity to the SensorTag device from your Raspberry Pi 3 device

Before running the sample, you need to verify that your Raspberry Pi 3 can connect to the SensorTag device.

1. Unblock bluetooth on the Raspberry Pi 3 and check that the version number is **5.37**.
    
    ```
    sudo rfkill unblock bluetooth
    bluetoothctl --version
    ```

2. Execute the **bluetoothctl** command. You are now in an interactive bluetooth shell. 

3. Enter the command **power on** to power up the bluetooth controller. You should see output similar to:
    
    ```
    [NEW] Controller 98:4F:EE:04:1F:DF C3 raspberrypi [default]
    ```

4. While still in the interactive bluetooth shell, enter the command **scan on** to scan for bluetooth devices. You should see output similar to:
    
    ```
    Discovery started
    [CHG] Controller 98:4F:EE:04:1F:DF Discovering: yes
    ```

5. Make the SensorTag device discoverable by pressing the small button (the green LED should flash). The Raspberry Pi 3 should discover the SensorTag device:
    
    ```
    [NEW] Device A0:E6:F8:B5:F6:00 CC2650 SensorTag
    [CHG] Device A0:E6:F8:B5:F6:00 TxPower: 0
    [CHG] Device A0:E6:F8:B5:F6:00 RSSI: -43
    ```
    
    In this example, you can see that the MAC address of the SensorTag device is **A0:E6:F8:B5:F6:00**.

6. Turn off scanning by entering the **scan off** command.
    
    ```
    [CHG] Controller 98:4F:EE:04:1F:DF Discovering: no
    Discovery stopped
    ```

7. Connect to your SensorTag device using its MAC address by entering **connect \<MAC address>**. Note that the sample output below is abbreviated:
    
    ```
    Attempting to connect to A0:E6:F8:B5:F6:00
    [CHG] Device A0:E6:F8:B5:F6:00 Connected: yes
    Connection successful
    [CHG] Device A0:E6:F8:B5:F6:00 UUIDs: 00001800-0000-1000-8000-00805f9b34fb
    ...
    [NEW] Primary Service
            /org/bluez/hci0/dev_A0_E6_F8_B5_F6_00/service000c
            Device Information
    ...
    [CHG] Device A0:E6:F8:B5:F6:00 GattServices: /org/bluez/hci0/dev_A0_E6_F8_B5_F6_00/service000c
    ...
    [CHG] Device A0:E6:F8:B5:F6:00 Name: SensorTag 2.0
    [CHG] Device A0:E6:F8:B5:F6:00 Alias: SensorTag 2.0
    [CHG] Device A0:E6:F8:B5:F6:00 Modalias: bluetooth:v000Dp0000d0110
    ```
    
    Note: You can list the GATT characteristics of the device again using the **list-attributes** command.

8. You can now disconnect from the device using the **disconnect** command and then exit from the bluetooth shell using the **quit** command:
    
    ```
    Attempting to disconnect from A0:E6:F8:B5:F6:00
    Successful disconnected
    [CHG] Device A0:E6:F8:B5:F6:00 Connected: no
    ```

You're now ready to run the BLE Gateway sample on your Raspberry Pi 3.

## Run the BLE Gateway sample

To run the BLE sample, you need to complete three tasks:

- Configure two sample devices in your IoT Hub.
- Build the IoT Gateway SDK on your Raspberry Pi 3 device.
- Configure and run the BLE sample on your Raspberry Pi 3 device.

At the time of writing, the IoT Gateway SDK only supports gateways that use BLE modules on Linux.

### Configure two sample devices in your IoT Hub

- [Create an IoT hub][lnk-create-hub] in your Azure subscription, you will need the name of your hub to complete this walkthrough. If you don't have an account, you can create a [free account][lnk-free-trial] in just a couple of minutes.
- Add one device called **SensorTag_01** to your IoT hub and make a note of its id and device key. You can use the [Device Explorer or iothub-explorer][lnk-explorer-tools] tools to add this device to the IoT hub you created in the previous step and to retrieve its key. You will map this device to the SensorTag device when you configure the gateway.

### Build the IoT Gateway SDK on your Raspberry Pi 3

Use the following **git** commands to clone the IoT Gateway SDK and all its submodules:

```
git clone --recursive https://github.com/Azure/azure-iot-gateway-sdk.git 
cd azure-iot-gateway-sdk
git submodule update --init --recursive
```

When you have a complete copy of the IoT Gateway SDK repository on your Raspberry Pi 3, you can build it using the following command from the folder that contains the SDK:

```
./tools/build.sh
```

### Configure and run the BLE sample on your Raspberry Pi 3

To bootstrap and run the sample, you need to configure each module that participates in the gateway. This configuration is provided in a JSON file and you need to configure all five participating modules. There is a sample JSON file provided in the repository called **gateway_sample.json** which you can use as the starting point for building your own configuration file. This file is in the **samples/ble_gateway_hl/src** folder in local copy of the IoT Gateway SDK repository.

The following sections describe how to edit this configuration file for the BLE sample and assume that the IoT Gateway SDK repository is in the **/home/root/azure-iot-gateway-sdk/** folder on your Raspberry Pi 3. If the repository is elsewhere, you should adjust the paths accordingly:

#### Logger configuration

Assuming the gateway repository is located in the folder **/home/root/azure-iot-gateway-sdk/**, configure the logger module as follows:

```json
{
    "module name": "logger",
    "loading args": {
      "module path": "/home/root/azure-iot-gateway-sdk/build/modules/logger/liblogger_hl.so"
    },
    "args":
    {
        "filename":"/home/root/gw_logger.log"
    }
}
```

#### BLE module configuration

The sample configuration for the BLE device assumes a Texas Instruments SensorTag device. Any standard BLE device that can operate as a GATT peripheral should work but you will need to update the GATT characteristic IDs and data (for write instructions). Add the MAC address of your SensorTag device: 

```json
{
  "module name": "SensorTag",
  "loading args": {
    "module path": "/home/root/azure-iot-gateway-sdk/build/modules/ble/libble_hl.so"
  },
  "args": {
    "controller_index": 0,
    "device_mac_address": "<<AA:BB:CC:DD:EE:FF>>",
    "instructions": [
      {
        "type": "read_once",
        "characteristic_uuid": "00002A24-0000-1000-8000-00805F9B34FB"
      },
      {
        "type": "read_once",
        "characteristic_uuid": "00002A25-0000-1000-8000-00805F9B34FB"
      },
      {
        "type": "read_once",
        "characteristic_uuid": "00002A26-0000-1000-8000-00805F9B34FB"
      },
      {
        "type": "read_once",
        "characteristic_uuid": "00002A27-0000-1000-8000-00805F9B34FB"
      },
      {
        "type": "read_once",
        "characteristic_uuid": "00002A28-0000-1000-8000-00805F9B34FB"
      },
      {
        "type": "read_once",
        "characteristic_uuid": "00002A29-0000-1000-8000-00805F9B34FB"
      },
      {
        "type": "write_at_init",
        "characteristic_uuid": "F000AA02-0451-4000-B000-000000000000",
        "data": "AQ=="
      },
      {
        "type": "read_periodic",
        "characteristic_uuid": "F000AA01-0451-4000-B000-000000000000",
        "interval_in_ms": 1000
      },
      {
        "type": "write_at_exit",
        "characteristic_uuid": "F000AA02-0451-4000-B000-000000000000",
        "data": "AA=="
      }
    ]
  }
}
```

#### IoT Hub module

Add the name of your IoT Hub. The suffix value is typically **azure-devices.net**:

```json
{
  "module name": "IoTHub",
  "loading args": {
    "module path": "/home/root/azure-iot-gateway-sdk/build/modules/iothub/libiothub_hl.so"
  },
  "args": {
    "IoTHubName": "<<Azure IoT Hub Name>>",
    "IoTHubSuffix": "<<Azure IoT Hub Suffix>>",
    "Transport": "HTTP"
  }
}
```

#### Identity mapping module configuration

Add the MAC address of your SensorTag device and the device Id and key of the **SensorTag_01** device you added to your IoT Hub:

```json
{
  "module name": "mapping",
  "loading args": {
    "module path": "/home/root/azure-iot-gateway-sdk/build/modules/identitymap/libidentity_map_hl.so"
  },
  "args": [
    {
      "macAddress": "<<AA:BB:CC:DD:EE:FF>>",
      "deviceId": "<<Azure IoT Hub Device ID>>",
      "deviceKey": "<<Azure IoT Hub Device Key>>"
    }
  ]
}
```

#### BLE Printer module configuration

```json
{
    "module name": "BLE Printer",
    "loading args": {
      "module path": "/home/root/azure-iot-gateway-sdk/build/samples/ble_gateway_hl/ble_printer/libble_printer.so"
    },
    "args": null
}
```

#### Routing configuration

The following configuration ensures the following:
- The **Logger** module receives and logs all messages.
- The **SensorTag** module sends messages to both the **mapping** and **BLE Printer** modules.
- The **mapping** module sends messages to the **IoTHub** module to be sent up to your IoT Hub.
- The **IoTHub** module sends messages back to the **mapping** module.
- The **mapping** module sends messages back to the **SensorTag** module.

```json
"links" : [
    {"source" : "*", "sink" : "Logger" },
    {"source" : "SensorTag", "sink" : "mapping" },
    {"source" : "SensorTag", "sink" : "BLE Printer" },
    {"source" : "mapping", "sink" : "IoTHub" },
    {"source" : "IoTHub", "sink" : "mapping" },
    {"source" : "mapping", "sink" : "SensorTag" }
  ]
```

To run the sample you run the **ble_gateway_hl** binary passing the path to the JSON configuration file. If you used the **gateway_sample.json** file, the command to execute looks like this:

```
./build/samples/ble_gateway_hl/ble_gateway_hl ./samples/ble_gateway_hl/src/gateway_sample.json
```

You may need to press the small button on the SensorTag device to make it discoverable before you run the sample.

When you run the sample, you can use the [Device Explorer or iothub-explorer][lnk-explorer-tools] tool to monitor the messages the gateway forwards from the SensorTag device.

## Send cloud-to-device messages

The BLE module also supports sending instructions from the Azure IoT Hub to the device. You can use the [Azure IoT Hub Device Explorer](https://github.com/Azure/azure-iot-sdks/blob/master/tools/DeviceExplorer/doc/how_to_use_device_explorer.md) or the [IoT Hub Explorer](https://github.com/Azure/azure-iot-sdks/tree/master/tools/iothub-explorer) to send JSON messages that the BLE gateway module passes on to the BLE device. For example, if you are using the Texas Instruments SensorTag device then you can send the following JSON messages to the device from IoT Hub.

- Reset all LEDs and the buzzer (turn them off)

    ```json
    {
      "type": "write_once",
      "characteristic_uuid": "F000AA65-0451-4000-B000-000000000000",
      "data": "AA=="
    }
    ```

- Configure I/O as 'remote'

    ```json
    {
      "type": "write_once",
      "characteristic_uuid": "F000AA66-0451-4000-B000-000000000000",
      "data": "AQ=="
    }
    ```

- Turn on the red LED

    ```json
    {
      "type": "write_once",
      "characteristic_uuid": "F000AA65-0451-4000-B000-000000000000",
      "data": "AQ=="
    }
    ```

- Turn on the green LED

    ```json
    {
      "type": "write_once",
      "characteristic_uuid": "F000AA65-0451-4000-B000-000000000000",
      "data": "Ag=="
    }
    ```

- Turn on the buzzer

    ```json
    {
      "type": "write_once",
      "characteristic_uuid": "F000AA65-0451-4000-B000-000000000000",
      "data": "BA=="
    }
    ```

The default behavior for a device using the HTTP protocol to connect to IoT Hub is to check every 25 minutes for a new command. Therefore, if you send several separate commands you need to wait 25 minutes for the device to receive each command.

> [AZURE.NOTE] The gateway also checks for new commands whenever it starts so you can force it to process a command by stopping and starting the gateway.

## Next steps

If you want to gain a more advanced understanding of the IoT Gateway SDK and experiment with some code examples, visit the following developer tutorials and resources:

- [Azure IoT Gateway SDK][lnk-sdk]

To further explore the capabilities of IoT Hub, see:

- [Developer guide][lnk-devguide]

<!-- Links -->
[lnk-ble-samplecode]: https://github.com/Azure/azure-iot-gateway-sdk/blob/master/samples/ble_gateway_hl
[lnk-free-trial]: https://azure.microsoft.com/pricing/free-trial/
[lnk-explorer-tools]: https://github.com/Azure/azure-iot-sdks/blob/master/doc/manage_iot_hub.md
[lnk-sdk]: https://github.com/Azure/azure-iot-gateway-sdk/
[lnk-noobs]: https://www.raspberrypi.org/documentation/installation/noobs.md
[lnk-raspbian]: https://www.raspberrypi.org/downloads/raspbian/


[lnk-devguide]: iot-hub-devguide.md
[lnk-create-hub]: iot-hub-create-through-portal.md 
